<!-- templates/kubeBoard/index.html -->

{% extends "base.html" %}
{% block title %}Kubernetes Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <!-- Display Error Messages -->
    {% if error %}
        <div class="alert alert-danger text-center" role="alert">
            {{ error }}
        </div>
    {% endif %}

    <!-- Remove the Kubeconfig Selection Dropdown from here -->

    <!-- Cluster Overviews Grouped by Kubeconfig File -->
    <div class="card mb-4 shadow-lg">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-server mr-2"></i>Kubeconfig: {{ overviews.0.kubeconfig_file }}</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Namespaces Card -->
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-info shadow h-100">
                        <div class="card-header">
                            <i class="fas fa-sitemap mr-2"></i>Namespaces
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <h5 class="card-title">{{ overviews.0.total_namespaces }}</h5>
                        </div>
                    </div>
                </div>
                <!-- Total Pods Card -->
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-success shadow h-100">
                        <div class="card-header">
                            <i class="fas fa-cubes mr-2"></i>Total Pods
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <h5 class="card-title">{{ overviews.0.total_pods }}</h5>
                        </div>
                    </div>
                </div>
                <!-- Running Pods Card -->
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-warning shadow h-100">
                        <div class="card-header">
                            <i class="fas fa-play-circle mr-2"></i>Running Pods
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <h5 class="card-title">{{ overviews.0.phase_counts.Running|default:0 }}</h5>
                        </div>
                    </div>
                </div>
                <!-- Failed Pods Card -->
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-danger shadow h-100">
                        <div class="card-header">
                            <i class="fas fa-times-circle mr-2"></i>Failed Pods
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <h5 class="card-title">{{ overviews.0.phase_counts.Failed|default:0 }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pods Overview -->
    <div class="card shadow-lg p-4 mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-podcast mr-2"></i>Pods Overview</h4>
            <a href="{% url 'index_page' %}" class="btn btn-light btn-sm">View All Pods</a>
        </div>
        <div class="card-body">
            <!-- Tabulator Table for Pods -->
            <div id="pods-table"></div>
        </div>
    </div>

    <!-- Events Overview -->
    <div class="card shadow-lg p-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-bell mr-2"></i>Events Overview</h4>
            <a href="{% url 'index_page' %}" class="btn btn-light btn-sm">View All Events</a>
        </div>
        <div class="card-body">
            <!-- Tabulator Table for Events -->
            <div id="events-table"></div>
        </div>
    </div>
</div>

<!-- Include Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pvgEHI1a6kkKqiKZOb7KxH8I3BzPQstwPl+M1HWzh2k/S+wyj1x9Iu7aaFTXv8VhegIumzIHYCrVfn7+JSLg7A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Parse the pods data passed from Django
        var podsData = {{ pods_data_json|safe }};

        // Initialize Tabulator for Pods
        var podsTable = new Tabulator("#pods-table", {
            data: podsData,
            layout: "fitColumns",
            responsiveLayout: "collapse",
            pagination: "local", // Enable local pagination
            paginationSize: 10,  // Number of rows per page
            movableColumns: true,
            placeholder: "No Pods Available",
            initialSort: [
                {column: "kubeconfig_file", dir: "asc"},
                {column: "name", dir: "asc"}
            ],
            columns: [
                {
                    title: "Kubeconfig File",
                    field: "kubeconfig_file",
                    headerFilter: "input",
                    headerSort: true,
                },
                {
                    title: "Name",
                    field: "name",
                    headerFilter: "input",
                    headerSort: true,
                    formatter: function(cell, formatterParams) {
                        return `<a href="${cell.getData().details_url}" target="_blank">${cell.getValue()}</a>`;
                    }
                },
                { title: "Namespace", field: "namespace", headerFilter: "input", headerSort: true },
                { title: "Status", field: "status", headerFilter: "input", headerSort: true },
                { title: "Node", field: "node", headerFilter: "input", headerSort: true },
                { title: "Age", field: "age", headerFilter: "input", headerSort: true },
            ],
        });

        // Parse the events data passed from Django
        var eventsData = {{ events_data_json|safe }};

        // Initialize Tabulator for Events
        var eventsTable = new Tabulator("#events-table", {
            data: eventsData,
            layout: "fitColumns",
            responsiveLayout: "collapse",
            pagination: "local", // Enable local pagination
            paginationSize: 10,  // Number of rows per page
            movableColumns: true,
            placeholder: "No Events Available",
            initialSort: [
                {column: "last_seen", dir: "desc"}
            ],
            columns: [
                {
                    title: "Kubeconfig File",
                    field: "kubeconfig_file",
                    headerFilter: "input",
                    headerSort: true,
                },
                {
                    title: "Event Name",
                    field: "event_name",
                    headerFilter: "input",
                    headerSort: true,
                    formatter: function(cell, formatterParams) {
                        var data = cell.getRow().getData();
                        var url = data.details_url;
                        if (url && url !== "#") {
                            return `<a href="${url}" target="_blank">${cell.getValue()}</a>`;
                        } else {
                            return cell.getValue();
                        }
                    }
                },
                { title: "Object Name", field: "object_name", headerFilter: "input", headerSort: true },
                { title: "Namespace", field: "namespace", headerFilter: "input", headerSort: true },
                { title: "Kind", field: "kind", headerFilter: "input", headerSort: true },
                { title: "Type", field: "type", headerFilter: "input", headerSort: true },
                { title: "Reason", field: "reason", headerFilter: "input", headerSort: true },
                { title: "Message", field: "message", headerFilter: "input", headerSort: true },
                { title: "First Seen", field: "first_seen", headerFilter: "input", headerSort: true },
                { title: "Last Seen", field: "last_seen", headerFilter: "input", headerSort: true },
            ],
        });
    });
</script>
{% endblock %}