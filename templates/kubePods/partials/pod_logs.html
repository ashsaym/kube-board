<!-- templates/kubePods/partials/pod_logs.html -->

<div class="accordion-item">
    <h2 class="accordion-header" id="headingLogs">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseLogs" aria-expanded="false"
                aria-controls="collapseLogs">
            <i class="bi bi-stickies me-2"></i> Real-Time Logs
        </button>
    </h2>
    <div id="collapseLogs" class="accordion-collapse collapse"
         aria-labelledby="headingLogs" data-bs-parent="#podDetailsAccordion">
        <div class="accordion-body">
            <!-- Connection Status -->
            <div id="connection-status" class="mb-3 text-center"></div>

            <!-- Controls Container: Left (Container and Filter) and Right (Buttons) -->
            <div class="controls-container mb-3 d-flex justify-content-between align-items-center flex-wrap">
                <!-- Left Controls: Container Select and Log Level Filter -->
                <div class="left-controls d-flex align-items-center mb-2 mb-md-0">
                    <!-- Container Selection -->
                    <div class="control-group me-3">
                        <label for="container-select" class="form-label me-2">Container:</label>
                        <select id="container-select" class="form-select">
                            {% for container in containers %}
                                <option value="{{ container }}" {% if container == containers.0 %}selected{% endif %}>
                                    {{ container }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Log Level Filter -->
                    <div class="control-group">
                        <label for="log-level-filter" class="form-label me-2">Filter:</label>
                        <select id="log-level-filter" class="form-select">
                            <option value="all">All</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                </div>

                <!-- Right Controls: Buttons -->
                <div class="right-controls d-flex align-items-center">
                    <button id="pause-logs" class="btn btn-sm btn-outline-secondary me-2">Pause</button>
                    <button id="resume-logs" class="btn btn-sm btn-outline-secondary me-2" disabled>Resume</button>
                    <button id="jump-to-latest" class="btn btn-sm btn-outline-secondary">Jump Latest</button>
                </div>
            </div>

            <!-- Kubectl Command Section -->
            <div class="kubectl-command-section mb-3 p-3 border rounded position-relative">
                <pre id="kubectl-command-text" class="mb-0 bg-dark text-light p-2" style="padding-right: 50px;"></pre>
                <button id="copy-command" class="btn btn-sm btn-dark copy-button">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>

            <!-- Log Container -->
            <div id="log-container" class="mb-3"></div>
        </div>
    </div>
</div>

<!-- SSE and Log Handling Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const namespace = "{{ selected_namespace }}";
        const podName = "{{ pod_name }}";
        const containers = {{ containers|safe }};
        const logContainer = document.getElementById('log-container');
        const pauseButton = document.getElementById('pause-logs');
        const resumeButton = document.getElementById('resume-logs');
        const jumpButton = document.getElementById('jump-to-latest');
        const connectionStatus = document.getElementById('connection-status');
        const containerSelect = document.getElementById('container-select');
        const logFilter = document.getElementById('log-level-filter');
        const kubectlCommandText = document.getElementById('kubectl-command-text');
        const copyCommand = document.getElementById('copy-command');
        let eventSource = null;
        let isPaused = false;
        let filterLevel = "all";

        // Update kubectl command display
        function updateKubectlCommand() {
            const container = containerSelect.value;
            const command = container ?
                `kubectl logs -f ${podName} -n ${namespace} -c ${container}` :
                `kubectl logs -f ${podName} -n ${namespace}`;
            kubectlCommandText.textContent = command;
        }

        // Initial command generation
        updateKubectlCommand();

        // Listen for container selection change to update command and reset log stream
        containerSelect.addEventListener('change', function () {
            updateKubectlCommand();
            resetSSE(this.value);
        });

        // Listen for log filter change to apply filtering
        logFilter.addEventListener('change', function () {
            filterLevel = this.value;
            filterExistingLogs();
        });

        // Function to filter existing logs based on selected filter level
        function filterExistingLogs() {
            const allLogLines = logContainer.querySelectorAll('div');
            allLogLines.forEach(function (logLine) {
                if (filterLevel === "all") {
                    logLine.style.display = "";
                } else {
                    logLine.style.display = logLine.classList.contains(`log-${filterLevel}`) ? "" : "none";
                }
            });
        }

        // Initialize Server-Sent Events (SSE) for log streaming
        function initSSE(containerName) {
            if (!containerName) {
                console.error("No container name provided.");
                logContainer.innerHTML = "<div class='log-error'>No container selected.</div>";
                return;
            }
            const sse_url = `/pods/${encodeURIComponent(namespace)}/${encodeURIComponent(podName)}/stream-logs/${encodeURIComponent(containerName)}/`;
            eventSource = new EventSource(sse_url);

            eventSource.onmessage = function (e) {
                if (isPaused) return;
                const data = JSON.parse(e.data);
                const log = data.log;
                let logClass = 'log-info';
                const upperLog = log.toUpperCase();
                if (upperLog.includes('ERROR')) {
                    logClass = 'log-error';
                } else if (upperLog.includes('WARNING') || upperLog.includes('WARN')) {
                    logClass = 'log-warning';
                }

                if (filterLevel !== "all" && logClass !== `log-${filterLevel}`) {
                    return;
                }

                const logLine = document.createElement('div');
                logLine.textContent = log;
                logLine.classList.add(logClass);
                logContainer.appendChild(logLine);
                logContainer.scrollTop = logContainer.scrollHeight;
            };

            eventSource.onerror = function (e) {
                console.error("SSE error:", e);
                connectionStatus.textContent = "Error receiving logs.";
                connectionStatus.className = 'text-danger';
                const errorLine = document.createElement('div');
                errorLine.textContent = "Error receiving logs.";
                errorLine.classList.add('log-error');
                logContainer.appendChild(errorLine);
                eventSource.close();
            };

            eventSource.onopen = function () {
                connectionStatus.textContent = `Connected to log stream for container "${containerSelect.value}".`;
                connectionStatus.className = 'text-success';
                logContainer.scrollTop = logContainer.scrollHeight;
            };
        }

        // Function to reset SSE connection
        function resetSSE(containerName) {
            if (eventSource) {
                eventSource.close();
            }
            logContainer.innerHTML = "";
            connectionStatus.textContent = "Reconnecting...";
            connectionStatus.className = '';
            initSSE(containerName);
        }

        // Initialize SSE on page load with the default selected container
        if (containerSelect) {
            initSSE(containerSelect.value);
        } else if (containers.length === 1) {
            initSSE(containers[0]);
        }

        // Pause Logs Button Handler
        pauseButton.addEventListener('click', function () {
            isPaused = true;
            connectionStatus.textContent = "Log streaming paused.";
            connectionStatus.className = 'text-warning';
            pauseButton.disabled = true;
            resumeButton.disabled = false;
        });

        // Resume Logs Button Handler
        resumeButton.addEventListener('click', function () {
            if (isPaused && (!eventSource || eventSource.readyState === EventSource.CLOSED)) {
                resetSSE(containerSelect.value);
            }
            isPaused = false;
            connectionStatus.textContent = "Log streaming resumed.";
            connectionStatus.className = 'text-success';
            pauseButton.disabled = false;
            resumeButton.disabled = true;
        });

        // Jump to Latest Logs Button Handler
        jumpButton.addEventListener('click', function () {
            logContainer.scrollTop = logContainer.scrollHeight;
        });

        // Copy kubectl command to clipboard
        copyCommand.addEventListener('click', function () {
            navigator.clipboard.writeText(kubectlCommandText.textContent)
                .then(() => {
                    copyCommand.innerHTML = '<i class="bi bi-clipboard-check"></i>';
                    setTimeout(() => {
                        copyCommand.innerHTML = '<i class="bi bi-clipboard"></i>';
                    }, 2000);
                })
                .catch(err => {
                    console.error("Failed to copy command: ", err);
                });
        });

        // Scroll to latest logs when the accordion is expanded
        const logsCollapse = document.getElementById('collapseLogs');
        logsCollapse.addEventListener('shown.bs.collapse', function () {
            logContainer.scrollTop = logContainer.scrollHeight;
        });

        // Clean up SSE connection when the page is unloaded
        window.addEventListener('beforeunload', function () {
            if (eventSource) {
                eventSource.close();
            }
        });
    });
</script>

<style>
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    .controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .left-controls,
    .right-controls {
        display: flex;
        align-items: center;
    }

    .left-controls .control-group {
        display: flex;
        align-items: center;
    }

    .control-group label {
        margin-bottom: 0;
    }

    #log-container {
        width: 100%;
        height: 50em;
        border-radius: 8px;
        border: 1px solid #444;
        overflow-y: auto;
        background: linear-gradient(135deg, #1e1e1e, #3a3a3a);
        color: #cfcfcf;
        padding: 15px;
        font-family: "Courier New", Courier, monospace;
        white-space: pre-wrap;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        scroll-behavior: smooth;
    }

    #log-container div {
        padding: 3px 0;
        border-bottom: 1px dotted rgba(255, 255, 255, 0.1);
    }

    .log-error {
        color: #ff6b6b;
        font-weight: bold;
    }

    .log-warning {
        color: #f4d35e;
    }

    .log-info {
        color: #6bc1ff;
    }

    #connection-status {
        font-size: 1.1em;
        padding: 5px;
        border-radius: 5px;
        background-color: #f8f9fa;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    #connection-status.text-success {
        color: #198754 !important;
    }

    #connection-status.text-warning {
        color: #ffc107 !important;
    }

    #connection-status.text-danger {
        color: #dc3545 !important;
    }

    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: #fff;
    }

    .kubectl-command-section {
        background-color: #343a40;
        color: #f8f9fa;
        border-color: #495057;
        position: relative;
    }

    #kubectl-command-text {
        background-color: #212529;
        color: #f8f9fa;
        border-radius: 4px;
    }

    .btn-dark {
        background-color: #495057;
        border: none;
    }

    .btn-dark:hover {
        background-color: #6c757d;
    }

    .copy-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #495057;
        border: none;
    }

    .copy-button:hover {
        background-color: #6c757d;
    }

    @media (max-width: 767.98px) {
        .controls-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .right-controls {
            margin-top: 10px;
        }
    }
</style>